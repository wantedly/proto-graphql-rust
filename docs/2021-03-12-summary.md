# [2021/03/08 - 2021/03/12] まとめ

## インターンタスク1: refine-image-rustのgRPC化

- 前回（先々週、02/08 - 02/19）のインターンの続き
- What?
  - refine-image-rustは、（people-goから名刺の）画像を受け取って、画像をrefineして、それを返すサービス。
  - これをHTTP/JSON APIからgRPCに置き換える。
    - gRPCはサービス間通信に特化していて効率的
    - protoでAPIを定義できる
- 前回は:
  - refine-image-rust（サーバ）側の移行が完了（本番環境にデプロイ）
  - people-go（クライアント）側があと少し

### 今週の成果

- people-go側の移行が完了（本番環境にデプロイ）
  - https://github.com/wantedly/people-go/pull/4154
  - 今週やったのは実質このコミット(DIでコネクションを作ってサービスまで引っ張ってくる)だけ: https://github.com/wantedly/people-go/pull/4154/commits/fb1cdc64bd42b87b73be27242e02a0b7c1f203d6
- refine-image-rustからHTTP/JSON APIサーバ（スムーズに移行するため一時的に両方のサーバが共存してた）を削除するPRを提出
  - https://github.com/wantedly/refine-image-rust/pull/331

#### 関連PRs

- Migrate refine_image_service to gRPC https://github.com/wantedly/people-go/pull/4154 (前回からの継続)
- Remove JSON API server https://github.com/wantedly/refine-image-rust/pull/331
- Update tokio and tonic https://github.com/wantedly/refine-image-rust/pull/332

## インターンタスク2: visit-api-node (wantedly-bff-graphql) をRustで書く技術検証

- 前回（先々週、02/08 - 02/19）のインターンの続き
- 前回は:
  - protoを解析して、「graphqlによるリクエストを単に適切なgRPCサービスにプロキシ/ルーティングする単純なサービス（ゲートウェイ）」を生成するコードジェネレータの基本的な部分の実装。
  - protoのほとんどのオブジェクトのgraphqlスキーマへの変換に関する暫定的な規則の作成。
  - それらに関する詳細な発表資料の作成。
    - https://github.com/wantedly/dx/issues/328#issuecomment-781953959
    - マークダウンで600行、GitHubのissueコメントだと5回くらいスクロールする必要があった。
    - なお、前回の成果発表では、時間制限に引っかかって全部発表しきれなかった。

### 今週の成果

- 階層化されたドキュメントの作成
  - https://github.com/wantedly/bff-graphql-rust/pull/14
  - 前回の発表資料をベースにいくつか例を追加した。
  - まだ微妙に箇条書きの部分が残ってるけど、一番重要（？）なスキーマ変換のところは文章にした。
  - 全体的にかなり読みやすくなったはず。
  - ただ、読むのはちょっと一手間必要で、リポジトリをcloneしてdocs/book/index.htmlをブラウザで開く必要がある。
    > 通常はmdbookが生成したHTMLはメインリポジトリにはコミットせずにGitHub Pagesなどに上げるが、プライベートレポで同じことやるのはめんどそうだったので生成物もコミットし、リポジトリをクローンして読めるようにした。
- gRPC Server Streaming RPCを GraphQL Subscriptionとして表現できるかの実験と例
  - https://github.com/wantedly/bff-graphql-rust/pull/15
  - gRPCのServer Streaming RPCは、クライアントからの一つのリクエストに対して、サーバが複数のレスポンスを返すような通信方式
    - サーバから任意のタイミングでクライアントにPush通知を送るようなイメージ。
  - GraphQLのSubscriptionも大体似たような感じ
  - 複雑なケースはわからないけど、例レベルなら十分に機能するっぽい
  - gRPCの他のStreaming RPC（Client Streaming RPCとBidirectional Streaming RPC）はクライアントがstreaｍなので、GraphQLでどう表現したらいいのかわからない...
- wantedly/apisの全てのprotoからRustコードを生成するとtestがハングすることがわかった: https://github.com/wantedly/bff-graphql-rust/pull/12
  - コンパイラに渡すフラグが影響しているらしく、`--all-targets`ってフラグを削除したら機能する。
  - いずれにしても大量のprotoに対応するゲートウェイを単一のサーバで担う場合は似たような問題が出てきそう。
- Apollo Federationの実験と例
  - https://github.com/wantedly/bff-graphql-rust/pull/9
  - ビルド時間の問題の回避策として検討したのがApollo Federationと呼ばれる複数のGraphQLサービスを組み合わせて一つのGraphQLサービスに見せかけることができるAPIゲートウェイ
    - 公式ドキュメント: https://www.apollographql.com/docs/federation/
    - もともと前回の発表終了後にizumin5210さんから教えてもらった
      - https://github.com/wantedly/wantedly-graphql-gateway/issues/35
  - この方法だと各マイクロサービスリポジトリでGraphQLサーバを持って、それをApollo serverで集約する形になる
    - 複数の言語による別のサーバが各リポジトリにあるのは問題が起きそう
  - 複雑なケースはわからないけど、例レベルなら十分に機能するっぽい
    - Federation用のコード生成と通常のコード生成では必要なものが微妙に違ってて、おそらくprotoへのアノテーションが増えることになる
      - 実際MergedObjectの問題ではFederation用か否かの違いで私(@taiki-e)が混乱してるところがあって上手く説明できてない...
    - ただ、リレーションを作成するために現在奇妙なハック（後述）が必要で、使用できるレベルではない
- MergedObjectと自動生成の相性の問題
  - https://github.com/wantedly/bff-graphql-rust/issues/10
  - 自動生成されたコードに加えて、GraphQLでのオブジェクト間のリレーションを追加したいときに、Rustの型システムと競合して.... (TODO)
- RustのGraphQLサーバ実装のバグやドキュメントの間違いの修正
  - https://github.com/async-graphql/async-graphql/pull/438
  - https://github.com/async-graphql/async-graphql/pull/439
  - https://github.com/async-graphql/async-graphql/pull/434
  - https://github.com/async-graphql/async-graphql/pull/433

#### 関連PRs

- Initial implementation https://github.com/wantedly/bff-graphql-rust/pull/2 (前回からの継続)
- Better docs https://github.com/wantedly/bff-graphql-rust/pull/14
- Add 2021-02-19-summary https://github.com/wantedly/bff-graphql-rust/pull/13
- Build apis https://github.com/wantedly/bff-graphql-rust/pull/12
- Generate GraphQL Subscription from gRPC Server Streaming RPC https://github.com/wantedly/bff-graphql-rust/pull/15
- Store gRPC client in Context https://github.com/wantedly/bff-graphql-rust/pull/16
- Apollo Federation https://github.com/wantedly/bff-graphql-rust/pull/9
